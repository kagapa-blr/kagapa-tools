<!DOCTYPE html>
<html lang="kn">

<head>
  <meta charset="UTF-8">
  <title data-i18n="tools.user_dictionary_dashboard.title">User Dictionary Manager</title>

  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- App Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/user_dictionary.css') }}">

  <script type="module" src="{{ url_for('static', filename='cdn/dataTables/jquery-3.7.1.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='cdn/dataTables/dataTables.dataTables.min.css') }}">
  <script type="module" src="{{ url_for('static', filename='js/navbar-auth.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='cdn/dataTables/dataTables.min.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/user_dictionary.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/language-switch.js') }}"></script>

</head>

<body class="bg-light">
  {% include 'navbar.html' %}

  <!-- Loading Overlay -->
  <div id="globalLoadingOverlay" class="loading-overlay d-none text-center text-light">
    <div class="spinner-border mb-2" role="status"></div>
    <div class="small" data-i18n="common.loading">Processing request‚Ä¶ Please wait</div>
  </div>

  <!-- Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center" id="infoModalLabel">
            <i class="bi bi-info-circle me-2 text-primary"></i>
            <span id="infoModalTitle"></span>
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="infoModalDescription" class="mb-2"></p>
          <ul id="infoModalDetails" class="mb-0 ps-3"></ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal"
            data-i18n="common.open_tool">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container py-4">
    <div class="mb-4">
      <h3 class="fw-semibold mb-1" data-i18n="tools.user_dictionary_dashboard.title">
        User Dictionary ‚Äì Admin Dashboard
      </h3>
      <p data-i18n="tools.user_dictionary_dashboard.subtitle" class="text-muted mb-1">
        Review and manage words submitted from all spellcheck clients.
      </p>
      <p data-i18n="tools.user_dictionary_dashboard.overview" class="text-muted small mb-0"></p>
    </div>

    <div class="row g-3">
      <!-- Left Panel: Manual Operations -->
      <div class="col-lg-4 d-flex flex-column gap-3">

        <!-- Add Words -->
        <div class="card shadow-sm border-0 h-100">
          <div
            class="card-header bg-white border-0 border-bottom d-flex justify-content-between align-items-center py-2">
            <div class="d-flex flex-column">
              <div class="d-flex align-items-center">
                <span
                  class="card-header-icon card-header-icon-primary me-2 d-inline-flex align-items-center justify-content-center">
                  Ôºã
                </span>
                <span class="fw-semibold" data-i18n="tools.user_dictionary.title">Add Words Manually</span>
              </div>
              <div class="text-muted small mt-1">
                Quickly queue and submit words to the dictionary.
              </div>
            </div>
            <button class="btn btn-outline-secondary btn-icon btn-sm rounded-circle" data-info-section="add"
              title="How to use">
              <i class="bi bi-info-lg"></i>
            </button>
          </div>
          <div class="card-body">
            <div class="input-group mb-2">
              <input type="text" id="addWordsInput" class="form-control form-control-sm"
                placeholder="Type word(s), press Enter or click Add">
              <button id="addWordBtn" class="btn btn-primary btn-sm" data-i18n="common.open_tool">Add</button>
            </div>
            <small class="text-muted d-block mb-2">Multiple words: comma or space separated.</small>
            <div id="addWordsChips" class="mb-3"></div>
            <div class="d-flex gap-2">
              <button id="addSubmitBtn" class="btn btn-success btn-sm flex-grow-1">Submit Queued Words</button>
              <button id="addClearBtn" class="btn btn-outline-secondary btn-sm">Clear Queue</button>
            </div>
          </div>
        </div>

        <!-- Delete Words -->
        <div class="card shadow-sm border-0 h-100">
          <div
            class="card-header bg-white border-0 border-bottom d-flex justify-content-between align-items-center py-2">
            <div class="d-flex flex-column">
              <div class="d-flex align-items-center">
                <span
                  class="card-header-icon card-header-icon-danger me-2 d-inline-flex align-items-center justify-content-center">
                  üóë
                </span>
                <span class="fw-semibold">Remove Words Manually</span>
              </div>
              <div class="text-muted small mt-1">
                Queue words to remove from the user dictionary.
              </div>
            </div>
            <button class="btn btn-outline-secondary btn-icon btn-sm rounded-circle" data-info-section="delete"
              title="How to use">
              <i class="bi bi-info-lg"></i>
            </button>
          </div>
          <div class="card-body">
            <div class="input-group mb-2">
              <input type="text" id="removeWordsInput" class="form-control form-control-sm"
                placeholder="Type word(s) to remove">
              <button id="removeWordBtn" class="btn btn-danger btn-sm">Queue Delete</button>
            </div>
            <small class="text-muted d-block mb-2">Removes from user dictionary (pending list).</small>
            <div id="removeWordsChips" class="mb-3"></div>
            <div class="d-flex gap-2">
              <button id="removeSubmitBtn" class="btn btn-danger btn-sm flex-grow-1">Delete Queued Words</button>
              <button id="removeClearBtn" class="btn btn-outline-secondary btn-sm">Clear Queue</button>
            </div>
          </div>
        </div>

        <!-- Bulk Upload -->
        <div class="card shadow-sm border-0 h-100">
          <div
            class="card-header bg-white border-0 border-bottom d-flex justify-content-between align-items-center py-2">
            <div class="d-flex flex-column">
              <div class="d-flex align-items-center">
                <span
                  class="card-header-icon card-header-icon-success me-2 d-inline-flex align-items-center justify-content-center">
                  ‚¨Ü
                </span>
                <span class="fw-semibold">Bulk Upload from Documents</span>
              </div>
              <div class="text-muted small mt-1">
                Extract words and update their frequencies in bulk.
              </div>
            </div>
            <button class="btn btn-outline-secondary btn-icon btn-sm rounded-circle" data-info-section="upload"
              title="How to use">
              <i class="bi bi-info-lg"></i>
            </button>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="fileInput" class="form-label small fw-semibold">Upload Document</label>
              <input type="file" id="fileInput" class="form-control form-control-sm" accept=".txt,.docx">
              <small class="text-muted">Supports .txt and .docx files.</small>
            </div>
            <div class="mb-3">
              <label for="addedByInput" class="form-label small fw-semibold">Source Label (Optional)</label>
              <input type="text" id="addedByInput" class="form-control form-control-sm"
                placeholder="e.g. team name, project, editor">
            </div>
            <button id="uploadBtn" class="btn btn-primary btn-sm w-100 mb-2">Upload &amp; Process Words</button>
            <div id="uploadResultCounts" class="d-none"></div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Table & Log -->
      <div class="col-lg-8 d-flex flex-column gap-3">

        <!-- Pending Words Table -->
        <div class="card shadow-sm border-0">
          <div
            class="card-header bg-white border-0 border-bottom d-flex flex-wrap justify-content-between align-items-center gap-2 p-3">
            <div class="d-flex flex-column">
              <div class="d-flex align-items-center">
                <span
                  class="card-header-icon card-header-icon-primary me-2 fs-5 d-inline-flex align-items-center justify-content-center">
                  üìÑ
                </span>
                <span class="fw-semibold" data-i18n="tools.user_dictionary_dashboard.table">
                  Pending User-Submitted Words
                </span>
              </div>
              <div class="text-muted small mt-1">
                Search, select and approve or delete pending words.
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <div class="input-group input-group-sm" style="width: 260px;">
                <input id="tableSearchInput" class="form-control" placeholder="Filter by word or added_by">
                <button id="tableSearchBtn" class="btn btn-outline-primary">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <button id="approveSelectedBtn" class="btn btn-success btn-sm px-3" title="Approve to main dictionary">
                <i class="bi bi-check-circle me-1"></i>Approve Selected
              </button>
              <button id="deleteSelectedBtn" class="btn btn-danger btn-sm px-3" title="Remove from pending list">
                <i class="bi bi-trash me-1"></i>Delete Selected
              </button>
              <button id="refreshTableBtn" class="btn btn-outline-secondary btn-sm" title="Refresh data">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="px-3 pt-3 pb-2 small text-muted">
              <i class="bi bi-info-circle-fill me-1"></i>
              Use checkboxes to select rows. Approve moves to main dictionary. Delete removes from pending list.
            </div>
            <div class="table-responsive">
              <table id="userWordsTable" class="table table-striped table-hover table-sm align-middle mb-0">
                <thead class="table-light position-sticky top-0">
                  <tr>
                    <th style="width: 40px;">
                      <input type="checkbox" id="selectAllRows">
                    </th>
                    <th style="width: 25%;">Word</th>
                    <th style="width: 25%;">Added By</th>
                    <th style="width: 15%;">Frequency</th>
                    <th style="width: 25%;">Created At</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Activity Log -->
        <div class="card shadow-lg border-0">
          <div
            class="card-header bg-gradient-to-r from-slate-50 to-blue-50 border-0 border-bottom d-flex justify-content-between align-items-center p-4 position-relative overflow-hidden">
            <!-- Subtle accent line -->
            <div
              class="position-absolute start-0 top-0 bottom-0 w-1 bg-gradient-to-b from-blue-500 to-blue-600 shadow-sm">
            </div>

            <div class="d-flex flex-column pe-3">
              <div class="d-flex align-items-center mb-2">
                <span
                  class="card-header-icon bg-blue-100 text-blue-600 me-3 fs-4 p-2 rounded-3 shadow-sm d-inline-flex align-items-center justify-content-center">
                  üìù
                </span>
                <span class="fw-bold fs-5 lh-sm" data-i18n="tools.user_dictionary_dashboard.log">
                  Admin Activity Log
                </span>
              </div>
              <div class="text-muted small lh-sm">
                Chronological list of actions performed in this dashboard
              </div>
            </div>

            <button
              class="btn btn-outline-secondary btn-sm rounded-pill px-3 py-1 fw-semibold shadow-sm hover-shadow-lg transition-all"
              data-info-section="log" title="Log details">
              <i class="bi bi-info-circle me-1"></i>Details
            </button>
          </div>

          <div class="card-body p-0">
            <div id="logArea" class="bg-gradient-to-b from-white to-slate-50 text-sm leading-relaxed font-mono"
              style="max-height: 280px; overflow-y: auto; font-family: 'SF Mono', 'JetBrains Mono', Consolas, monospace; line-height: 1.5; border-top: 1px solid rgba(59, 130, 246, 0.08); padding: 1rem 1.25rem;">
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>

  {% include 'footer.html' %}


  <!-- Fixed Info Modal Handler - Pure JSON Dynamic -->
  <script>
    (function () {
      let currentTranslations = {};

      function waitForTranslations() {
        return new Promise(resolve => {
          const checkTranslations = () => {
            const sample = document.querySelector('[data-i18n="app.title"]');
            if (sample && sample.textContent.trim() && sample.textContent !== 'app.title') {
              resolve();
            } else {
              setTimeout(checkTranslations, 100);
            }
          };
          checkTranslations();
        });
      }

      const modalConfig = {
        add: {
          titleKey: 'tools.user_dictionary.title',
          descriptionKey: 'tools.user_dictionary_dashboard.overview',
          points: [
            'tools.user_dictionary_dashboard.manual_add_delete',
            'Type words separated by comma/space, press Enter or click Add to queue',
            'Click "Submit Queued Words" to save to user dictionary'
          ]
        },
        delete: {
          titleKey: 'Remove Words Manually',
          descriptionKey: 'tools.user_dictionary_dashboard.overview',
          points: [
            'Type exact words to remove, click "Queue Delete"',
            'Click "Delete Queued Words" to remove from pending list',
            'Removes only from user dictionary (pending table)'
          ]
        },
        upload: {
          titleKey: 'Bulk Upload from Documents',
          descriptionKey: 'tools.user_dictionary_dashboard.upload',
          points: [
            'Upload .txt or .docx files - automatically tokenized',
            'Frequencies updated for existing words, new words added',
            'Optional source label tracks upload origin'
          ]
        },
        approve: {
          titleKey: 'Approve Selected Words',
          descriptionKey: 'tools.user_dictionary_dashboard.selection',
          points: [
            'Select rows using checkboxes or "Select All"',
            'Approved words move to main dictionary',
            'Removed from pending list after approval'
          ]
        },
        'bulk-delete': {
          titleKey: 'Delete Selected Words',
          descriptionKey: 'tools.user_dictionary_dashboard.selection',
          points: [
            'Bulk delete multiple selected rows',
            'Confirmation dialog prevents accidents',
            'Permanently removes from pending list'
          ]
        },
        log: {
          titleKey: 'tools.user_dictionary_dashboard.log',
          descriptionKey: 'tools.user_dictionary_dashboard.log',
          points: [
            'Real-time session log of dashboard operations',
            'Shows add/delete/upload/approve actions',
            'Newest events appear at the top'
          ]
        }
      };

      async function initModal() {
        await waitForTranslations();

        const infoModalEl = document.getElementById('infoModal');
        const infoModal = new bootstrap.Modal(infoModalEl);
        const titleEl = document.getElementById('infoModalTitle');
        const descEl = document.getElementById('infoModalDescription');
        const listEl = document.getElementById('infoModalDetails');

        function showInfo(section) {
          const config = modalConfig[section];
          if (!config) return;

          titleEl.textContent = resolveSafe(config.titleKey);
          descEl.textContent = resolveSafe(config.descriptionKey);

          listEl.innerHTML = '';
          config.points.forEach(pointKey => {
            const li = document.createElement('li');
            li.className = 'mb-1';
            li.textContent = resolveSafe(pointKey);
            listEl.appendChild(li);
          });

          infoModal.show();
        }

        function resolveSafe(key) {
          const el = document.querySelector(`[data-i18n="${CSS.escape(key)}"]`);
          if (el && el.textContent.trim() && el.textContent !== key) {
            return el.textContent.trim();
          }
          return key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
        }

        function handleClick() {
          showInfo(this.dataset.infoSection);
        }

        document.querySelectorAll('[data-info-section]').forEach(btn => {
          btn.addEventListener('click', handleClick);
        });

        const observer = new MutationObserver(() => {
          document.querySelectorAll('[data-info-section]').forEach(btn => {
            btn.removeEventListener('click', handleClick);
            btn.addEventListener('click', handleClick);
          });
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ['data-i18n']
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initModal);
      } else {
        initModal();
      }
    })();
  </script>
</body>

</html>